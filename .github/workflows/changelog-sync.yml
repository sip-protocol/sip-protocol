name: Sync Changelog to docs-sip

on:
  repository_dispatch:
    types: [changelog-updated]
  push:
    branches: [main]
    paths:
      - 'CHANGELOG.md'
  workflow_dispatch:

jobs:
  sync-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sip-protocol
        uses: actions/checkout@v6

      - name: Checkout docs-sip
        uses: actions/checkout@v6
        with:
          repository: sip-protocol/docs-sip
          token: ${{ secrets.DOCS_SYNC_TOKEN }}
          path: docs-sip

      - name: Transform and sync changelog
        run: |
          # Read the SDK changelog
          SDK_CHANGELOG=$(cat CHANGELOG.md)

          # Create the docs-compatible version with frontmatter
          cat > docs-sip/src/content/docs/changelog.md << 'FRONTMATTER'
          ---
          title: Changelog
          description: Release history for SIP Protocol SDK
          ---
          FRONTMATTER

          # Append the changelog content (skip first line if it's a duplicate title)
          echo "" >> docs-sip/src/content/docs/changelog.md
          echo "$SDK_CHANGELOG" | tail -n +2 >> docs-sip/src/content/docs/changelog.md

          # Add links section
          cat >> docs-sip/src/content/docs/changelog.md << 'LINKS'

          ---

          ## Links

          - [GitHub Releases](https://github.com/sip-protocol/sip-protocol/releases)
          - [npm Package](https://www.npmjs.com/package/@sip-protocol/sdk)
          - [Roadmap](/roadmap/)
          LINKS

      - name: Commit and push to docs-sip
        working-directory: docs-sip
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git add src/content/docs/changelog.md
          git commit -m "docs: sync changelog from SDK ${{ github.sha }}"
          git push
